---
description: 项目整体架构和开发基准指南
globs:
  - "**/*"
alwaysApply: true
---

# Home Voice Box 项目架构与开发基准

本文档总结了 Home Voice Box 项目的整体架构、技术栈、开发模式和最佳实践，作为未来开发的基准和参考。

## 1. 项目概述

### 1.1 项目定位

Home Voice Box 是一个基于 Cloudflare Pages 的 Serverless 智能家居语音控制平台，连接天猫精灵和 Home Assistant，实现通过语音指令控制智能家居设备。

### 1.2 核心功能

- 🎤 **语音控制**：通过天猫精灵语音指令控制 Home Assistant 设备
- 🗺️ **意图映射管理**：可视化界面管理意图与设备操作的映射关系
- ⚡ **内存缓存**：意图映射数据存储在内存中，查询速度极快
- 🔒 **安全认证**：管理员密码保护，所有接口和页面都需要登录
- 🏠 **设备支持**：支持灯光、风扇和开关设备的开关、切换等操作
- 🎯 **自定义回复**：可以为每个意图配置自定义的语音回复内容
- ☁️ **Serverless**：基于 Cloudflare Pages，无需维护服务器

## 2. 技术栈

### 2.1 后端技术

- **运行环境**：Cloudflare Workers (Serverless)
- **运行时**：V8 JavaScript Engine
- **存储**：Cloudflare Workers KV (键值存储)
- **API 框架**：Cloudflare Pages Functions
- **认证方式**：Cookie-based Session

### 2.2 前端技术

- **框架**：原生 HTML + Alpine.js (轻量级响应式框架)
- **样式**：Tailwind CSS (实用优先的 CSS 框架)
- **构建工具**：无需构建，直接部署静态文件

### 2.3 第三方集成

- **Home Assistant**：通过 REST API 控制智能家居设备
- **天猫精灵**：接收 AliGenie SDK V3.0 格式的语音指令

## 3. 项目结构

```
ds-voice-box/
├── functions/                    # Cloudflare Pages Functions (后端)
│   ├── _middleware.js           # 全局中间件（认证、路由、缓存初始化）
│   ├── [path].js                # 动态登录路径处理
│   ├── api/                     # API 接口
│   │   ├── tomi.js             # 天猫精灵接口（核心）
│   │   ├── intents.js          # 意图映射 CRUD
│   │   ├── intents/[id].js     # 单个意图映射操作
│   │   ├── ha-entities.js      # Home Assistant 设备列表
│   │   ├── login.js            # 登录接口
│   │   ├── logout.js           # 登出接口
│   │   └── check-auth.js       # 认证检查接口
│   ├── utils/                   # 工具函数
│   │   ├── ha-common.js        # Home Assistant 公共方法（配置、服务调用）
│   │   ├── ha-light-api.js     # 灯光设备控制 API
│   │   ├── ha-fan-api.js       # 风扇设备控制 API
│   │   ├── ha-switch-api.js    # 开关设备控制 API
│   │   ├── ha-status-api.js    # 设备状态查询 API
│   │   ├── intent-cache.js     # 意图映射内存缓存
│   │   └── auth.js             # 认证工具函数
│   └── aligenie/                # 天猫精灵域名校验
│       └── [filename].js       # 动态文件名处理
├── docs/                        # 项目文档（HTML 格式）
│   ├── index.html              # 文档首页
│   ├── home-assistant.html     # Home Assistant 部署指南
│   ├── cloudflare-tunnel.html  # Cloudflare Tunnel 配置
│   ├── cloudflare-pages.html   # Cloudflare Pages 部署
│   ├── aligenie-setup.html    # 天猫精灵平台配置
│   ├── configuration.html      # 配置指南
│   ├── usage.html              # 使用指南
│   └── api.html                # API 文档
├── .cursor/                     # Cursor IDE 规则
│   └── rules/
│       ├── project-architecture.mdc  # 项目架构规则（本文件）
│       └── add-device-type.mdc     # 添加设备类型指南
├── manage.html                  # 管理界面（意图映射管理）
├── index.html                   # 首页（重定向到文档）
├── README.md                    # 项目说明
├── .dev.vars.example           # 环境变量示例
├── wrangler.toml               # Cloudflare Workers 配置
└── wrangler.local.toml         # 本地开发配置
```

## 4. 核心架构设计

### 4.1 请求处理流程

```
用户请求
  ↓
_middleware.js (中间件)
  ├── 认证检查
  ├── 路由处理
  └── 缓存初始化
  ↓
API 处理函数
  ├── 参数验证
  ├── 业务逻辑处理
  └── 响应返回
```

### 4.2 数据流

```
意图映射数据流：
  创建/更新/删除
    ↓
  KV 存储（持久化）
    ↓
  内存缓存（同步更新）
    ↓
  查询（优先从缓存读取）

设备控制流程：
  天猫精灵请求
    ↓
  /api/tomi
    ↓
  提取意图标识
    ↓
  查询意图映射（缓存）
    ↓
  调用 Home Assistant API
    ↓
  返回语音回复
```

### 4.3 缓存策略

- **存储位置**：全局 Map 对象（内存）
- **初始化时机**：首次访问 `/api/tomi` 或 `/api/intents` 时
- **更新策略**：增删改操作时同步更新缓存
- **持久化**：数据存储在 KV 中，缓存作为加速层

### 4.4 认证机制

- **方式**：Cookie-based Session
- **密码存储**：环境变量 `ADMIN_PASSWORD`
- **登录路径**：动态路径（`LOGIN_PATH` 环境变量）
- **保护范围**：除公开路径外的所有页面和接口

## 5. 关键组件说明

### 5.1 中间件 (`functions/_middleware.js`)

**职责**：
- 全局请求拦截
- 认证检查
- 路由处理（动态登录路径）
- 缓存初始化

**关键逻辑**：
- 公开路径列表：`/`, `/index.html`, `/docs/`, `/api/login`, `/api/logout`, `/api/check-auth`, `/aligenie/`, `/api/tomi`
- 动态登录路径：根据 `LOGIN_PATH` 环境变量判断

### 5.2 天猫精灵接口 (`functions/api/tomi.js`)

**职责**：
- 接收天猫精灵的语音指令请求
- 提取意图标识
- 查询意图映射
- 调用对应的 Home Assistant API
- 返回天猫精灵格式的响应

**关键逻辑**：
- 支持 `TOMI_SECRET_KEY` 验证（可选）
- 使用 `apiHandlerMap` 映射 API 名称到执行函数
- 错误处理统一返回语音回复

### 5.3 意图映射管理 (`functions/api/intents.js`)

**职责**：
- 意图映射的 CRUD 操作
- 与 KV 存储交互
- 同步更新内存缓存

**数据结构**：
```javascript
{
  id: 1,
  intentName: "TurnOnLight",      // 意图标识（天猫精灵）
  apiName: "turnOnLight",         // API 名称（后端）
  apiLabel: "打开灯光",            // API 标签（前端显示）
  entityId: "light.kitchen",      // 实体ID（Home Assistant）
  replyContent: "好的，已为您打开灯光"  // 回复内容（可选）
}
```

### 5.4 设备 API (`functions/utils/ha-*-api.js`)

**设计模式**：
- 所有设备 API 共享公共方法（`ha-common.js`）
- 每个设备类型一个文件
- 统一函数签名：`(env, entityId, options = {})`

**公共方法**：
- `getHAConfig(env)` - 获取 Home Assistant 配置
- `callHAService(env, domain, service, data)` - 调用 Home Assistant 服务

**标准函数**：
- `turnOn{DeviceType}` - 打开设备
- `turnOff{DeviceType}` - 关闭设备
- `toggle{DeviceType}` - 切换设备状态

### 5.5 内存缓存 (`functions/utils/intent-cache.js`)

**设计**：
- 全局 Map 对象存储映射关系
- 键：意图标识（intentName）
- 值：映射对象

**关键函数**：
- `getCache(context)` - 获取缓存（懒加载）
- `getIntentMapping(context, intentName)` - 查询映射
- `updateCacheItem(intentName, mapping)` - 更新缓存
- `deleteCacheItem(intentName)` - 删除缓存项
- `reloadCache(context)` - 重新加载缓存

## 6. 开发模式与最佳实践

### 6.1 代码组织原则

1. **单一职责**：每个文件只负责一个功能模块
2. **公共方法提取**：重复代码提取到公共文件（如 `ha-common.js`）
3. **命名规范**：
   - 文件：kebab-case（如 `ha-light-api.js`）
   - 函数：camelCase（如 `turnOnLight`）
   - 常量：UPPER_SNAKE_CASE（如 `TOMI_SECRET_KEY`）

### 6.2 错误处理

- **统一错误格式**：返回天猫精灵格式的错误响应
- **日志记录**：使用 `console.log` 和 `console.error` 记录关键操作
- **用户友好**：错误信息转换为语音回复

### 6.3 安全实践

- **环境变量**：敏感信息存储在环境变量中
- **动态登录路径**：防止直接访问登录页面
- **API 密钥验证**：可选但推荐的 `TOMI_SECRET_KEY` 验证
- **认证检查**：所有管理接口和页面都需要认证

### 6.4 扩展性设计

- **设备类型扩展**：通过添加新的 `ha-*-api.js` 文件
- **接口映射**：在 `tomi.js` 的 `apiHandlerMap` 中注册
- **前端支持**：在 `manage.html` 的 `allApis` 中添加
- **文档更新**：同步更新相关文档

## 7. 环境变量配置

### 7.1 必需变量

| 变量名 | 说明 | 获取方式 |
|--------|------|----------|
| `HA_URL` | Home Assistant 服务器地址 | 如：`http://192.168.1.100:8123` |
| `HA_TOKEN` | Home Assistant 长期访问令牌 | Home Assistant 设置中生成 |
| `ADMIN_PASSWORD` | 管理员登录密码 | 自定义 |
| `LOGIN_PATH` | 登录页面的访问路径 | 自定义，如 `aaa` |
| `KV_BINDING_NAME` | KV Namespace 绑定名称 | Cloudflare Dashboard 配置 |
| `ALIGENIE_NAME` | 天猫精灵校验文件名 | 天猫精灵开放平台 |
| `ALIGENIE_CONTENT` | 天猫精灵校验文件内容 | 天猫精灵开放平台 |

### 7.2 可选变量

| 变量名 | 说明 | 推荐 |
|--------|------|------|
| `TOMI_SECRET_KEY` | 天猫精灵接口验证密钥 | 强烈推荐设置 |

## 8. 开发工作流

### 8.1 本地开发

```bash
# 安装依赖
npm install -g wrangler

# 配置环境变量
cp .dev.vars.example .dev.vars
# 编辑 .dev.vars 文件

# 启动开发服务器
npx wrangler pages dev . --ip 0.0.0.0

# 如果需要 KV（本地开发）
npx wrangler pages dev . --ip 0.0.0.0 --kv INTENTS_KV=your_kv_namespace_id
```

### 8.2 部署流程

1. **推送代码**：将代码推送到 Git 仓库
2. **Cloudflare Pages**：在 Dashboard 中创建项目并连接 Git
3. **配置环境变量**：在项目设置中配置所有环境变量
4. **配置 KV**：创建 KV Namespace 并绑定到项目
5. **自动部署**：每次推送代码后自动部署

### 8.3 添加新功能流程

1. **后端开发**：在 `functions/` 目录下添加或修改文件
2. **前端更新**：如需要，更新 `manage.html`
3. **文档更新**：更新相关文档（`docs/` 目录）
4. **测试验证**：本地测试后部署到生产环境

## 9. 常见开发场景

### 9.1 添加新设备类型

参考 `.cursor/rules/add-device-type.mdc` 文件，完整流程包括：
1. 创建设备 API 文件
2. 在 `tomi.js` 中注册
3. 更新状态查询 API（可选）
4. 更新前端管理界面
5. 更新项目文档

### 9.2 添加新 API 接口

1. 在 `functions/api/` 目录下创建新文件
2. 实现 `onRequestGet`、`onRequestPost` 等处理函数
3. 如需认证，中间件会自动处理
4. 更新 API 文档

### 9.3 修改前端界面

1. 直接编辑 `manage.html` 或文档文件
2. 使用 Alpine.js 进行响应式交互
3. 使用 Tailwind CSS 进行样式设计
4. 无需构建，直接部署

## 10. 注意事项

### 10.1 Cloudflare Workers 限制

- **执行时间**：免费版最多 10 秒，付费版最多 30 秒
- **内存限制**：128 MB
- **请求大小**：100 MB
- **KV 操作**：每次请求最多 1000 次读取或 1000 次写入

### 10.2 性能优化

- **缓存策略**：使用内存缓存减少 KV 读取
- **批量操作**：避免在循环中进行 KV 操作
- **异步处理**：使用 `Promise.all` 并行处理

### 10.3 调试技巧

- **本地日志**：使用 `console.log` 和 `console.error`
- **生产日志**：在 Cloudflare Dashboard 中查看实时日志
- **错误追踪**：检查响应状态码和错误信息

## 11. 项目依赖

### 11.1 运行时依赖

- **Cloudflare Workers**：Serverless 运行环境
- **Alpine.js**：前端响应式框架（CDN）
- **Tailwind CSS**：CSS 框架（CDN）

### 11.2 开发工具

- **Wrangler**：Cloudflare Workers 开发工具
- **Node.js**：本地开发环境

## 12. 参考资源

- [Cloudflare Workers 文档](https://developers.cloudflare.com/workers/)
- [Cloudflare Pages 文档](https://developers.cloudflare.com/pages/)
- [Home Assistant API 文档](https://developers.home-assistant.io/docs/api/rest/)
- [天猫精灵开放平台](https://open.aligenie.com/)
- [Alpine.js 文档](https://alpinejs.dev/)
- [Tailwind CSS 文档](https://tailwindcss.com/docs)

## 13. 版本历史

### v1.0.0 (当前版本)

- ✅ 基础功能实现（意图映射、设备控制）
- ✅ 支持 light、fan、switch 设备类型
- ✅ 内存缓存机制
- ✅ 安全认证
- ✅ 完整文档

---

**维护者**：开发团队  
**最后更新**：2025年  
**项目地址**：https://github.com/xinFengQi/ds-voice-box

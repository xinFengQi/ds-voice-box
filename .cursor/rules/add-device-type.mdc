---
description: æ·»åŠ æ–°çš„ Home Assistant è®¾å¤‡ç±»å‹å¯¹æ¥æŒ‡å—
globs:
  - "functions/utils/ha-*-api.js"
  - "functions/api/tomi.js"
alwaysApply: false
---

# æ·»åŠ æ–°è®¾å¤‡ç±»å‹å¯¹æ¥æŒ‡å—

å½“éœ€è¦æ·»åŠ æ–°çš„ Home Assistant è®¾å¤‡ç±»å‹ï¼ˆå¦‚ switchã€coverã€climate ç­‰ï¼‰æ—¶ï¼Œè¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

## 1. åˆ›å»ºè®¾å¤‡ API æ–‡ä»¶

åœ¨ `functions/utils/` ç›®å½•ä¸‹åˆ›å»ºæ–°çš„è®¾å¤‡ API æ–‡ä»¶ï¼Œå‘½åæ ¼å¼ï¼š`ha-{device-type}-api.js`

**å‘½åç¤ºä¾‹ï¼š**
- `ha-switch-api.js` - å¼€å…³è®¾å¤‡
- `ha-cover-api.js` - çª—å¸˜/å·å¸˜è®¾å¤‡
- `ha-climate-api.js` - ç©ºè°ƒ/æ¸©æ§å™¨è®¾å¤‡

### æ–‡ä»¶ç»“æ„æ¨¡æ¿

**é‡è¦ï¼š** å¿…é¡»ä» `ha-common.js` å¯¼å…¥ `callHAService` æ–¹æ³•ï¼Œä¸è¦é‡å¤å®šä¹‰å…¬å…±æ–¹æ³•ã€‚

```javascript
/**
 * Home Assistant {è®¾å¤‡ç±»å‹} æ§åˆ¶ API
 * ç”¨äºæ§åˆ¶{è®¾å¤‡ç±»å‹}è®¾å¤‡
 */

import { callHAService } from './ha-common.js';

/**
 * æ‰“å¼€{è®¾å¤‡ç±»å‹}
 * @param {Object} env - Cloudflare Workers ç¯å¢ƒå˜é‡
 * @param {string} entityId - è®¾å¤‡å®ä½“IDï¼ˆå¦‚ '{domain}.kitchen'ï¼‰
 * @param {Object} options - å¯é€‰å‚æ•°ï¼ˆæ ¹æ®è®¾å¤‡ç±»å‹è°ƒæ•´ï¼‰
 * @returns {Promise<Object>} API å“åº”
 */
export async function turnOn{DeviceType}(env, entityId, options = {}) {
  const data = { entity_id: entityId };
  
  // æ ¹æ®è®¾å¤‡ç±»å‹æ·»åŠ ç‰¹å®šå‚æ•°
  // if (options.someParam) {
  //   data.some_param = options.someParam;
  // }

  return await callHAService(env, '{domain}', 'turn_on', data);
}

/**
 * å…³é—­{è®¾å¤‡ç±»å‹}
 * @param {Object} env - Cloudflare Workers ç¯å¢ƒå˜é‡
 * @param {string} entityId - è®¾å¤‡å®ä½“ID
 * @returns {Promise<Object>} API å“åº”
 */
export async function turnOff{DeviceType}(env, entityId) {
  return await callHAService(env, '{domain}', 'turn_off', {
    entity_id: entityId
  });
}

/**
 * åˆ‡æ¢{è®¾å¤‡ç±»å‹}å¼€å…³çŠ¶æ€
 * @param {Object} env - Cloudflare Workers ç¯å¢ƒå˜é‡
 * @param {string} entityId - è®¾å¤‡å®ä½“ID
 * @returns {Promise<Object>} API å“åº”
 */
export async function toggle{DeviceType}(env, entityId) {
  return await callHAService(env, '{domain}', 'toggle', {
    entity_id: entityId
  });
}
```

**å ä½ç¬¦è¯´æ˜ï¼š**
- `{è®¾å¤‡ç±»å‹}` - è®¾å¤‡çš„ä¸­æ–‡åç§°ï¼ˆå¦‚ï¼šå¼€å…³ã€çª—å¸˜ã€ç©ºè°ƒï¼‰
- `{DeviceType}` - è®¾å¤‡ç±»å‹çš„è‹±æ–‡åç§°ï¼Œé¦–å­—æ¯å¤§å†™ï¼ˆå¦‚ï¼šSwitchã€Coverã€Climateï¼‰
- `{domain}` - Home Assistant çš„è®¾å¤‡åŸŸï¼ˆå¦‚ï¼šswitchã€coverã€climateï¼‰

**å®é™…ç¤ºä¾‹ï¼ˆå¼€å…³è®¾å¤‡ï¼‰ï¼š**

```javascript
/**
 * Home Assistant å¼€å…³æ§åˆ¶ API
 * ç”¨äºæ§åˆ¶å¼€å…³è®¾å¤‡
 */

import { callHAService } from './ha-common.js';

export async function turnOnSwitch(env, entityId) {
  return await callHAService(env, 'switch', 'turn_on', {
    entity_id: entityId
  });
}

export async function turnOffSwitch(env, entityId) {
  return await callHAService(env, 'switch', 'turn_off', {
    entity_id: entityId
  });
}

export async function toggleSwitch(env, entityId) {
  return await callHAService(env, 'switch', 'toggle', {
    entity_id: entityId
  });
}
```

### æ³¨æ„äº‹é¡¹

#### å¿…é¡»éµå¾ªçš„è§„åˆ™

1. **å¿…é¡»ä»å…¬å…±æ–‡ä»¶å¯¼å…¥**ï¼š
   - ä½¿ç”¨ `import { callHAService } from './ha-common.js';` å¯¼å…¥å…¬å…±æ–¹æ³•
   - **ä¸è¦**é‡å¤å®šä¹‰ `getHAConfig` å’Œ `callHAService` æ–¹æ³•
   - å¦‚æœéœ€è¦ `getHAConfig`ï¼ˆå¦‚çŠ¶æ€æŸ¥è¯¢ï¼‰ï¼Œä½¿ç”¨ `import { getHAConfig } from './ha-common.js';`

2. **å¿…é¡»å¯¼å‡ºçš„å‡½æ•°**ï¼š
   - è‡³å°‘å¯¼å‡ºä¸‰ä¸ªå‡½æ•°ï¼š`turnOn{DeviceType}`, `turnOff{DeviceType}`, `toggle{DeviceType}`
   - å‡½æ•°å‘½åä½¿ç”¨é©¼å³°å‘½åæ³•ï¼Œé¦–å­—æ¯å¤§å†™ï¼ˆå¦‚ `turnOnSwitch`, `turnOffSwitch`, `toggleSwitch`ï¼‰

3. **å‡½æ•°ç­¾å**ï¼š
   - æ‰€æœ‰åŸºç¡€å‡½æ•°å¿…é¡»æ¥å— `(env, entityId, options = {})` å‚æ•°
   - `env` - Cloudflare Workers ç¯å¢ƒå˜é‡å¯¹è±¡
   - `entityId` - Home Assistant å®ä½“IDï¼ˆå¦‚ `switch.kitchen`ï¼‰
   - `options` - å¯é€‰å‚æ•°å¯¹è±¡ï¼ˆæ ¹æ®è®¾å¤‡ç±»å‹æ”¯æŒçš„åŠŸèƒ½è°ƒæ•´ï¼‰

4. **æ‰©å±•åŠŸèƒ½**ï¼š
   - å¦‚æœè®¾å¤‡ç±»å‹æ”¯æŒå…¶ä»–æ“ä½œï¼ˆå¦‚è®¾ç½®äº®åº¦ã€é¢œè‰²ã€æ¸©åº¦ç­‰ï¼‰ï¼Œå¯ä»¥æ·»åŠ é¢å¤–çš„å¯¼å‡ºå‡½æ•°
   - å‚è€ƒ `@ha-light-api.js` ä¸­çš„ `setLightBrightness` å’Œ `setLightColor` å‡½æ•°
   - å‚è€ƒ `@ha-fan-api.js` ä¸­çš„ `setFanPercentage` å’Œ `setFanPresetMode` å‡½æ•°

#### å‚è€ƒå®ç°

- åŸºç¡€è®¾å¤‡ï¼š`@ha-switch-api.js` - æœ€ç®€å•çš„å®ç°ï¼Œåªæœ‰ä¸‰ä¸ªåŸºç¡€å‡½æ•°
- å¸¦å‚æ•°è®¾å¤‡ï¼š`@ha-light-api.js` - åŒ…å«äº®åº¦ã€é¢œè‰²ç­‰æ‰©å±•åŠŸèƒ½
- å¤æ‚è®¾å¤‡ï¼š`@ha-fan-api.js` - åŒ…å«é£é€Ÿã€é¢„è®¾æ¨¡å¼ã€æ‘†é£ç­‰å¤æ‚åŠŸèƒ½

#### å…¬å…±æ–¹æ³•è¯´æ˜

å…¬å…±æ–¹æ³•å®šä¹‰åœ¨ `@ha-common.js` ä¸­ï¼š

- `getHAConfig(env)` - è·å– Home Assistant API é…ç½®ï¼ˆURL å’Œ headersï¼‰
- `callHAService(env, domain, service, data)` - è°ƒç”¨ Home Assistant æœåŠ¡
  - `domain` - è®¾å¤‡åŸŸï¼ˆå¦‚ 'light', 'fan', 'switch'ï¼‰
  - `service` - æœåŠ¡åç§°ï¼ˆå¦‚ 'turn_on', 'turn_off', 'toggle'ï¼‰
  - `data` - è¯·æ±‚æ•°æ®å¯¹è±¡ï¼ˆå¿…é¡»åŒ…å« `entity_id`ï¼‰

## 2. åœ¨ tomi.js ä¸­æ³¨å†Œæ–°è®¾å¤‡

åœ¨ `functions/api/tomi.js` æ–‡ä»¶ä¸­ï¼š

### 2.1 å¯¼å…¥æ–°è®¾å¤‡çš„ API å‡½æ•°

åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥è¯­å¥ï¼ˆåœ¨ç°æœ‰å¯¼å…¥ä¹‹åï¼‰ï¼š

```javascript
import { turnOn{DeviceType}, turnOff{DeviceType}, toggle{DeviceType} } from '../utils/ha-{device-type}-api.js';
```

**å®é™…ç¤ºä¾‹ï¼ˆå¼€å…³è®¾å¤‡ï¼‰ï¼š**

```javascript
import { turnOnSwitch, turnOffSwitch, toggleSwitch } from '../utils/ha-switch-api.js';
```

**æ³¨æ„ï¼š** å¦‚æœè®¾å¤‡æœ‰é¢å¤–çš„å¯¼å‡ºå‡½æ•°ï¼ˆå¦‚ `setLightBrightness`ï¼‰ï¼Œä¹Ÿéœ€è¦ä¸€å¹¶å¯¼å…¥ã€‚

### 2.2 æ·»åŠ åˆ° apiHandlerMap

åœ¨ `apiHandlerMap` ä¸­æ·»åŠ æ–°çš„æ˜ å°„ï¼ˆåœ¨ç°æœ‰æ˜ å°„ä¹‹åï¼‰ï¼š

```javascript
const apiHandlerMap = new Map([
  // ... ç°æœ‰æ˜ å°„
  ['turnOn{DeviceType}', turnOn{DeviceType}],
  ['turnOff{DeviceType}', turnOff{DeviceType}],
  ['toggle{DeviceType}', toggle{DeviceType}]
]);
```

**å®é™…ç¤ºä¾‹ï¼ˆå¼€å…³è®¾å¤‡ï¼‰ï¼š**

```javascript
const apiHandlerMap = new Map([
  ['turnOnLight', turnOnLight],
  ['turnOffLight', turnOffLight],
  ['toggleLight', toggleLight],
  ['turnOnFan', turnOnFan],
  ['turnOffFan', turnOffFan],
  ['toggleFan', toggleFan],
  ['turnOnSwitch', turnOnSwitch],    // æ–°å¢
  ['turnOffSwitch', turnOffSwitch],  // æ–°å¢
  ['toggleSwitch', toggleSwitch]      // æ–°å¢
]);
```

### æ³¨æ„äº‹é¡¹

- **API åç§°æ ¼å¼**ï¼šä½¿ç”¨é©¼å³°å‘½åæ³•ï¼ˆå¦‚ `turnOnSwitch`, `turnOffSwitch`, `toggleSwitch`ï¼‰
- **ä¸€è‡´æ€§è¦æ±‚**ï¼šç¡®ä¿ API åç§°ä¸æ„å›¾æ˜ å°„ä¸­é…ç½®çš„ `apiName` å­—æ®µå®Œå…¨ä¸€è‡´
- **Map é”®å€¼**ï¼šMap çš„é”®ï¼ˆå­—ç¬¦ä¸²ï¼‰å¿…é¡»ä¸å‡½æ•°åå®Œå…¨åŒ¹é…
- **é¡ºåºæ— å…³**ï¼šåœ¨ Map ä¸­çš„é¡ºåºä¸å½±å“åŠŸèƒ½ï¼Œä½†å»ºè®®æŒ‰è®¾å¤‡ç±»å‹åˆ†ç»„

## 3. æ›´æ–°çŠ¶æ€æŸ¥è¯¢ APIï¼ˆå¯é€‰ï¼‰

å¦‚æœéœ€è¦åœ¨ç®¡ç†ç•Œé¢ä¸­æ˜¾ç¤ºæ–°è®¾å¤‡ç±»å‹ï¼Œæ›´æ–° `functions/utils/ha-status-api.js`ï¼š

### 3.1 æ›´æ–° getAllControllableDevices å‡½æ•°

åœ¨ `getAllControllableDevices` å‡½æ•°ä¸­æ·»åŠ æ–°è®¾å¤‡ç±»å‹ï¼š

```javascript
export async function getAllControllableDevices(env) {
  const [lights, fans, switches] = await Promise.all([
    getDevicesByDomain(env, 'light'),
    getDevicesByDomain(env, 'fan'),
    getDevicesByDomain(env, 'switch')  // æ·»åŠ æ–°è®¾å¤‡ç±»å‹
  ]);

  return {
    light: lights,
    fan: fans,
    switch: switches  // æ·»åŠ æ–°è®¾å¤‡ç±»å‹
  };
}
```

**å®é™…ç¤ºä¾‹ï¼ˆæ·»åŠ  cover è®¾å¤‡ï¼‰ï¼š**

```javascript
export async function getAllControllableDevices(env) {
  const [lights, fans, switches, covers] = await Promise.all([
    getDevicesByDomain(env, 'light'),
    getDevicesByDomain(env, 'fan'),
    getDevicesByDomain(env, 'switch'),
    getDevicesByDomain(env, 'cover')  // æ–°å¢
  ]);

  return {
    light: lights,
    fan: fans,
    switch: switches,
    cover: covers  // æ–°å¢
  };
}
```

### æ³¨æ„äº‹é¡¹

- å¦‚æœä¸éœ€è¦åœ¨ç®¡ç†ç•Œé¢ä¸­æ˜¾ç¤ºè¯¥è®¾å¤‡ç±»å‹ï¼Œå¯ä»¥è·³è¿‡æ­¤æ­¥éª¤
- `getDevicesByDomain` å‡½æ•°ä¼šè‡ªåŠ¨ä» Home Assistant è·å–æŒ‡å®šåŸŸçš„æ‰€æœ‰è®¾å¤‡
- è¿”å›å¯¹è±¡çš„é”®ååº”è¯¥ä¸è®¾å¤‡åŸŸåç§°ä¸€è‡´ï¼ˆå¦‚ `switch`, `cover`ï¼‰

## 4. æ›´æ–°å‰ç«¯ç®¡ç†ç•Œé¢ï¼ˆå¿…éœ€ï¼‰

å¦‚æœéœ€è¦åœ¨ç®¡ç†ç•Œé¢ä¸­é€‰æ‹©æ–°è®¾å¤‡ç±»å‹ï¼Œå¿…é¡»æ›´æ–° `manage.html` æ–‡ä»¶ï¼š

### 4.1 æ›´æ–° allApis å¯¹è±¡

åœ¨ `manage.html` çš„ `allApis` å¯¹è±¡ä¸­æ·»åŠ æ–°è®¾å¤‡ç±»å‹çš„æ¥å£åˆ—è¡¨ï¼š

```javascript
// æ‰€æœ‰å¯ç”¨çš„æ¥å£åˆ—è¡¨
allApis: {
    light: [
        { value: 'turnOnLight', label: 'æ‰“å¼€ç¯å…‰' },
        { value: 'turnOffLight', label: 'å…³é—­ç¯å…‰' },
        { value: 'toggleLight', label: 'åˆ‡æ¢ç¯å…‰' }
    ],
    fan: [
        { value: 'turnOnFan', label: 'æ‰“å¼€é£æ‰‡' },
        { value: 'turnOffFan', label: 'å…³é—­é£æ‰‡' },
        { value: 'toggleFan', label: 'åˆ‡æ¢é£æ‰‡' }
    ],
    {domain}: [  // æ·»åŠ æ–°è®¾å¤‡ç±»å‹
        { value: 'turnOn{DeviceType}', label: 'æ‰“å¼€{è®¾å¤‡ç±»å‹}' },
        { value: 'turnOff{DeviceType}', label: 'å…³é—­{è®¾å¤‡ç±»å‹}' },
        { value: 'toggle{DeviceType}', label: 'åˆ‡æ¢{è®¾å¤‡ç±»å‹}' }
    ]
}
```

**å®é™…ç¤ºä¾‹ï¼ˆå¼€å…³è®¾å¤‡ï¼‰ï¼š**

```javascript
allApis: {
    light: [
        { value: 'turnOnLight', label: 'æ‰“å¼€ç¯å…‰' },
        { value: 'turnOffLight', label: 'å…³é—­ç¯å…‰' },
        { value: 'toggleLight', label: 'åˆ‡æ¢ç¯å…‰' }
    ],
    fan: [
        { value: 'turnOnFan', label: 'æ‰“å¼€é£æ‰‡' },
        { value: 'turnOffFan', label: 'å…³é—­é£æ‰‡' },
        { value: 'toggleFan', label: 'åˆ‡æ¢é£æ‰‡' }
    ],
    switch: [  // æ–°å¢
        { value: 'turnOnSwitch', label: 'æ‰“å¼€å¼€å…³' },
        { value: 'turnOffSwitch', label: 'å…³é—­å¼€å…³' },
        { value: 'toggleSwitch', label: 'åˆ‡æ¢å¼€å…³' }
    ]
}
```

### 4.2 æ›´æ–°æç¤ºä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

å¦‚æœæç¤ºä¿¡æ¯ä¸­åˆ—å‡ºäº†æ”¯æŒçš„è®¾å¤‡ç±»å‹ï¼Œéœ€è¦åŒæ­¥æ›´æ–°ï¼š

```html
<p x-show="formData.entityId && filteredApis.length === 0" class="text-xs text-yellow-600 mt-1">
    æç¤ºï¼šå½“å‰è®¾å¤‡ç±»å‹ï¼ˆ<span x-text="getEntityDomain(formData.entityId)"></span>ï¼‰æš‚æ— å¯ç”¨æ¥å£ï¼Œç›®å‰ä»…æ”¯æŒ lightã€fan å’Œ {domain} ç±»å‹è®¾å¤‡
</p>
```

**å®é™…ç¤ºä¾‹ï¼ˆå¼€å…³è®¾å¤‡ï¼‰ï¼š**

```html
<p x-show="formData.entityId && filteredApis.length === 0" class="text-xs text-yellow-600 mt-1">
    æç¤ºï¼šå½“å‰è®¾å¤‡ç±»å‹ï¼ˆ<span x-text="getEntityDomain(formData.entityId)"></span>ï¼‰æš‚æ— å¯ç”¨æ¥å£ï¼Œç›®å‰ä»…æ”¯æŒ lightã€fan å’Œ switch ç±»å‹è®¾å¤‡
</p>
```

### æ³¨æ„äº‹é¡¹

- **å¿…éœ€æ€§**ï¼šå¦‚æœä¸åœ¨å‰ç«¯æ·»åŠ è®¾å¤‡ç±»å‹ï¼Œç”¨æˆ·åœ¨ç®¡ç†ç•Œé¢é€‰æ‹©è¯¥è®¾å¤‡æ—¶å°†çœ‹ä¸åˆ°å¯ç”¨çš„æ¥å£é€‰é¡¹
- **é”®åä¸€è‡´**ï¼š`allApis` å¯¹è±¡çš„é”®åå¿…é¡»ä¸è®¾å¤‡åŸŸåç§°å®Œå…¨ä¸€è‡´ï¼ˆå¦‚ `switch`, `cover`ï¼‰
- **API åç§°ä¸€è‡´**ï¼š`value` å­—æ®µå¿…é¡»ä¸åç«¯ `tomi.js` ä¸­æ³¨å†Œçš„ API åç§°å®Œå…¨ä¸€è‡´
- **æ ‡ç­¾æ¸…æ™°**ï¼š`label` å­—æ®µåº”è¯¥ä½¿ç”¨æ¸…æ™°çš„ä¸­æ–‡æè¿°ï¼Œä¾¿äºç”¨æˆ·ç†è§£

## 5. æ›´æ–°é¡¹ç›®æ–‡æ¡£

æ·»åŠ æ–°è®¾å¤‡ç±»å‹åï¼Œéœ€è¦åœ¨ä»¥ä¸‹æ–‡æ¡£ä¸­è¡¥å……ç›¸å…³å†…å®¹ï¼š

### 5.1 æ›´æ–°ä½¿ç”¨æŒ‡å— (`docs/usage.html`)

åœ¨"é€‰æ‹©è°ƒç”¨æ¥å£"éƒ¨åˆ†æ·»åŠ æ–°è®¾å¤‡ç±»å‹çš„æ¥å£é€‰é¡¹ï¼š

```html
<li>å¼€å…³è®¾å¤‡ï¼šæ‰“å¼€å¼€å…³ã€å…³é—­å¼€å…³ã€åˆ‡æ¢å¼€å…³</li>
```

### 5.2 æ›´æ–° API æ–‡æ¡£ (`docs/api.html`)

åœ¨è®¾å¤‡ç±»å‹è¯´æ˜ä¸­æ·»åŠ æ–°è®¾å¤‡ç±»å‹ï¼š

```html
<li><code class="bg-gray-100 px-1 rounded">domain</code>ï¼šè®¾å¤‡ç±»å‹ï¼ˆå¯é€‰ï¼Œå¦‚ï¼šlightã€fanã€switchï¼‰</li>
```

### 5.3 æ›´æ–° README.md

åœ¨"ç‰¹æ€§"éƒ¨åˆ†æ›´æ–°æ”¯æŒçš„è®¾å¤‡ç±»å‹ï¼š

```markdown
- ğŸ  **è®¾å¤‡æ”¯æŒ**ï¼šæ”¯æŒç¯å…‰ã€é£æ‰‡å’Œå¼€å…³è®¾å¤‡çš„å¼€å…³ã€åˆ‡æ¢ç­‰æ“ä½œ
```

### æ³¨æ„äº‹é¡¹

- ç¡®ä¿æ–‡æ¡£ä¸­çš„ç¤ºä¾‹ä¸å®é™…ä»£ç ä¿æŒä¸€è‡´
- å¦‚æœè®¾å¤‡ç±»å‹æœ‰ç‰¹æ®ŠåŠŸèƒ½ï¼Œéœ€è¦åœ¨æ–‡æ¡£ä¸­è¯¦ç»†è¯´æ˜
- ä¿æŒæ–‡æ¡£æ ¼å¼å’Œé£æ ¼ç»Ÿä¸€

## 6. æµ‹è¯•

å®Œæˆä»¥ä¸Šæ­¥éª¤åï¼Œè¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### 6.1 åŠŸèƒ½æµ‹è¯•

1. **åˆ›å»ºæ„å›¾æ˜ å°„**ï¼š
   - åœ¨ç®¡ç†ç•Œé¢ä¸­åˆ›å»ºæ„å›¾æ˜ å°„
   - ä½¿ç”¨æ–°çš„ API åç§°ï¼ˆå¦‚ `turnOnSwitch`ï¼‰
   - é€‰æ‹©å¯¹åº”çš„è®¾å¤‡å®ä½“IDï¼ˆå¦‚ `switch.kitchen`ï¼‰
   - é…ç½®å›å¤å†…å®¹ï¼ˆå¦‚ "å¥½çš„ï¼Œå·²ä¸ºæ‚¨æ‰“å¼€å¼€å…³"ï¼‰

2. **è¯­éŸ³æŒ‡ä»¤æµ‹è¯•**ï¼š
   - é€šè¿‡å¤©çŒ«ç²¾çµå‘é€è¯­éŸ³æŒ‡ä»¤
   - éªŒè¯è®¾å¤‡æ§åˆ¶æ˜¯å¦æ­£å¸¸å·¥ä½œ
   - æµ‹è¯•æ‰€æœ‰ä¸‰ä¸ªåŸºç¡€æ“ä½œï¼ˆæ‰“å¼€ã€å…³é—­ã€åˆ‡æ¢ï¼‰

3. **é”™è¯¯å¤„ç†æµ‹è¯•**ï¼š
   - æµ‹è¯•æ— æ•ˆçš„å®ä½“ID
   - æµ‹è¯•è®¾å¤‡ç¦»çº¿çš„æƒ…å†µ
   - æ£€æŸ¥é”™è¯¯å¤„ç†å’Œæ—¥å¿—è¾“å‡º

### 6.2 æ–‡æ¡£éªŒè¯

4. **æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥**ï¼š
   - éªŒè¯æ–‡æ¡£ä¸­çš„ç¤ºä¾‹æ˜¯å¦æ­£ç¡®
   - ç¡®ä¿ API åç§°ä¸ä»£ç ä¸€è‡´
   - æ£€æŸ¥è®¾å¤‡ç±»å‹è¯´æ˜æ˜¯å¦å®Œæ•´

### 6.3 ä»£ç æ£€æŸ¥

5. **ä»£ç è´¨é‡æ£€æŸ¥**ï¼š
   - ç¡®ä¿æ²¡æœ‰è¯­æ³•é”™è¯¯
   - ç¡®ä¿æ‰€æœ‰å¯¼å…¥æ­£ç¡®
   - ç¡®ä¿å‡½æ•°å‘½åç¬¦åˆè§„èŒƒ
   - è¿è¡Œ linter æ£€æŸ¥ä»£ç é£æ ¼

## å‚è€ƒç¤ºä¾‹

### å®Œæ•´å®ç°ç¤ºä¾‹

- **åŸºç¡€è®¾å¤‡**ï¼š`@ha-switch-api.js` - æœ€ç®€å•çš„å®ç°ï¼Œåªæœ‰ä¸‰ä¸ªåŸºç¡€å‡½æ•°
- **å¸¦å‚æ•°è®¾å¤‡**ï¼š`@ha-light-api.js` - åŒ…å«äº®åº¦ã€é¢œè‰²ç­‰æ‰©å±•åŠŸèƒ½
- **å¤æ‚è®¾å¤‡**ï¼š`@ha-fan-api.js` - åŒ…å«é£é€Ÿã€é¢„è®¾æ¨¡å¼ã€æ‘†é£ç­‰å¤æ‚åŠŸèƒ½

### å…¬å…±æ–¹æ³•å‚è€ƒ

- **å…¬å…±å·¥å…·**ï¼š`@ha-common.js` - åŒ…å« `getHAConfig` å’Œ `callHAService` æ–¹æ³•
- **çŠ¶æ€æŸ¥è¯¢**ï¼š`@ha-status-api.js` - è®¾å¤‡çŠ¶æ€æŸ¥è¯¢å®ç°å‚è€ƒ

## å¸¸è§è®¾å¤‡ç±»å‹

### åŸºç¡€æ§åˆ¶è®¾å¤‡

- `switch` - å¼€å…³ï¼ˆæ”¯æŒ turn_on, turn_off, toggleï¼‰
- `light` - ç¯å…‰ï¼ˆæ”¯æŒ turn_on, turn_off, toggleï¼Œå¯è®¾ç½®äº®åº¦ã€é¢œè‰²ï¼‰
- `fan` - é£æ‰‡ï¼ˆæ”¯æŒ turn_on, turn_off, toggleï¼Œå¯è®¾ç½®é£é€Ÿã€æ¨¡å¼ï¼‰

### å…¶ä»–è®¾å¤‡ç±»å‹

- `cover` - çª—å¸˜/å·å¸˜ï¼ˆæ”¯æŒ open_cover, close_cover, set_cover_positionï¼‰
- `climate` - ç©ºè°ƒ/æ¸©æ§å™¨ï¼ˆæ”¯æŒ set_temperature, set_hvac_modeï¼‰
- `lock` - æ™ºèƒ½é”ï¼ˆæ”¯æŒ lock, unlockï¼‰
- `media_player` - åª’ä½“æ’­æ”¾å™¨ï¼ˆæ”¯æŒ play_media, volume_setï¼‰
- `vacuum` - æ‰«åœ°æœºå™¨äººï¼ˆæ”¯æŒ start, stop, return_to_baseï¼‰

### è®¾å¤‡ API å‚è€ƒ

æ¯ç§è®¾å¤‡ç±»å‹å¯èƒ½æ”¯æŒä¸åŒçš„æœåŠ¡å’Œå‚æ•°ï¼Œè¯·å‚è€ƒä»¥ä¸‹èµ„æºï¼š

- [Home Assistant å®˜æ–¹æ–‡æ¡£](https://www.home-assistant.io/integrations/) - æŸ¥çœ‹è®¾å¤‡é›†æˆæ–‡æ¡£
- [Home Assistant æœåŠ¡æ–‡æ¡£](https://www.home-assistant.io/docs/scripts/service-calls/) - æŸ¥çœ‹æœåŠ¡è°ƒç”¨æ–‡æ¡£
- [Home Assistant API æ–‡æ¡£](https://developers.home-assistant.io/docs/api/rest/) - æŸ¥çœ‹ REST API æ–‡æ¡£

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆå¿…é¡»ä» ha-common.js å¯¼å…¥ï¼Ÿ

A: ä¸ºäº†é¿å…ä»£ç é‡å¤ï¼Œæ‰€æœ‰è®¾å¤‡ API å…±äº«ç›¸åŒçš„é…ç½®å’ŒæœåŠ¡è°ƒç”¨é€»è¾‘ã€‚å¦‚æœæ¯ä¸ªæ–‡ä»¶éƒ½é‡å¤å®šä¹‰è¿™äº›æ–¹æ³•ï¼Œä¼šå¯¼è‡´ä»£ç å†—ä½™å’Œç»´æŠ¤å›°éš¾ã€‚

### Q: å¦‚æœè®¾å¤‡ä¸æ”¯æŒ toggle æœåŠ¡æ€ä¹ˆåŠï¼Ÿ

A: å¦‚æœè®¾å¤‡ä¸æ”¯æŒ `toggle` æœåŠ¡ï¼Œå¯ä»¥åªå®ç° `turnOn` å’Œ `turnOff` å‡½æ•°ï¼Œå¹¶åœ¨ `tomi.js` ä¸­åªæ³¨å†Œè¿™ä¸¤ä¸ªæ˜ å°„ã€‚æˆ–è€…å¯ä»¥å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ toggle é€»è¾‘ã€‚

### Q: å¦‚ä½•æ·»åŠ è®¾å¤‡ç‰¹å®šçš„å‚æ•°ï¼Ÿ

A: åœ¨å‡½æ•°çš„ `options` å‚æ•°ä¸­æ·»åŠ è®¾å¤‡ç‰¹å®šçš„å‚æ•°ï¼Œç„¶ååœ¨è°ƒç”¨ `callHAService` å‰å°†è¿™äº›å‚æ•°æ·»åŠ åˆ° `data` å¯¹è±¡ä¸­ã€‚å‚è€ƒ `@ha-light-api.js` ä¸­çš„ `turnOnLight` å‡½æ•°å®ç°ã€‚

### Q: å¦‚ä½•æµ‹è¯•æ–°æ·»åŠ çš„è®¾å¤‡ç±»å‹ï¼Ÿ

A: é¦–å…ˆåœ¨ç®¡ç†ç•Œé¢åˆ›å»ºæ„å›¾æ˜ å°„ï¼Œç„¶åé€šè¿‡å¤©çŒ«ç²¾çµå‘é€è¯­éŸ³æŒ‡ä»¤ã€‚å¦‚æœé‡åˆ°é—®é¢˜ï¼Œæ£€æŸ¥ Cloudflare Workers çš„æ—¥å¿—è¾“å‡ºï¼ŒæŸ¥çœ‹é”™è¯¯ä¿¡æ¯ã€‚

### Q: ä¸ºä»€ä¹ˆåœ¨ç®¡ç†ç•Œé¢é€‰æ‹©äº†è®¾å¤‡ï¼Œä½†çœ‹ä¸åˆ°å¯ç”¨çš„æ¥å£ï¼Ÿ

A: è¿™æ˜¯å› ä¸ºå‰ç«¯ä»£ç ï¼ˆ`manage.html`ï¼‰ä¸­çš„ `allApis` å¯¹è±¡è¿˜æ²¡æœ‰æ·»åŠ è¯¥è®¾å¤‡ç±»å‹ã€‚éœ€è¦åœ¨ `allApis` å¯¹è±¡ä¸­æ·»åŠ å¯¹åº”çš„è®¾å¤‡åŸŸå’Œæ¥å£åˆ—è¡¨ã€‚å‚è€ƒæ­¥éª¤ 4ã€‚

### Q: å‰ç«¯å’Œåç«¯çš„ API åç§°å¿…é¡»ä¸€è‡´å—ï¼Ÿ

A: æ˜¯çš„ï¼Œå¿…é¡»å®Œå…¨ä¸€è‡´ã€‚å‰ç«¯çš„ `allApis` ä¸­çš„ `value` å­—æ®µå¿…é¡»ä¸åç«¯ `tomi.js` ä¸­ `apiHandlerMap` çš„é”®åå®Œå…¨ä¸€è‡´ï¼Œå¦åˆ™æ— æ³•æ­£ç¡®è°ƒç”¨æ¥å£ã€‚
